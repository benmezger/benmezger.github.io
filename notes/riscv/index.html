<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Backlinks #   RISCV   tags Computer Science Operating Systems Computer Architecture  Understanding RISCV stack pointer #  L06 RISCV Functions(6up).pdf #  Exceptions #  Exception are unusual condition occurring at run time associated with an instruction in the current RISCV thread. Exceptions may be converted to traps, but that all depends on the execution environment.
Traps #  Trap refers to the synchronous transfer control to a trap handler caused by an exceptional condition occurring within a RISC thread."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="RISCV"><meta property="og:description" content="Backlinks #   RISCV   tags Computer Science Operating Systems Computer Architecture  Understanding RISCV stack pointer #  L06 RISCV Functions(6up).pdf #  Exceptions #  Exception are unusual condition occurring at run time associated with an instruction in the current RISCV thread. Exceptions may be converted to traps, but that all depends on the execution environment.
Traps #  Trap refers to the synchronous transfer control to a trap handler caused by an exceptional condition occurring within a RISC thread."><meta property="og:type" content="article"><meta property="og:url" content="https://seds.nl/notes/riscv/"><meta property="article:published_time" content="2020-05-31T12:37:00-03:00"><meta property="article:modified_time" content="2020-06-06T03:25:02-03:00"><title>RISCV | Ben Mezger</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.d06c2941d6bb925f35bc6e968bc1590f01804052cae4ad5e9ad70d2906fac7a2.css integrity="sha256-0GwpQda7kl81vG6Wi8FZDwGAQFLK5K1emtcNKQb6x6I="><script defer src=/en.search.min.4a8b5abae0714d6e7d45db44d7caa480c69228285b5bb9526aa1582fb660ff6c.js integrity="sha256-SotauuBxTW59RdtE18qkgMaSKChbW7lSaqFYL7Zg/2w="></script><script defer src=/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js integrity="sha256-dKi7B/C+6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-138318350-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link type=text/css rel=stylesheet href=/assets/css/orgmode.css><link type=text/css rel=stylesheet href=/assets/css/custom.css></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>Ben Mezger</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/books/>Books</a></li></ul><ul><li><a href=/posts>Blog</a></li><li><a href=/notes>Notes</a></li><li><strong>Social</strong><ul><li><a href=https://github.com/benmezger/>Github</a></li><li><a href=https://twitter.com/sys%5Freboot>Twitter</a></li><li><a href=/index.xml>RSS</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>RISCV</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#backlinks>Backlinks</a></li></ul></li><li><a href=#understanding-riscv--2020-05-31-15-37-29z-riscv-dot-md--stack-pointer>Understanding <a href=HAHAHUGOSHORTCODE-s4-HBHB>RISCV</a> stack pointer</a><ul><li><a href=#l06-riscv-functions--6up--dot-pdf><a href=https://dynalist.io/u/5cYI9hHNgUYs0U47UXe0RZ6U>L06 RISCV Functions(6up).pdf</a></a></li></ul></li><li><a href=#exceptions>Exceptions</a></li><li><a href=#traps>Traps</a></li><li><a href=#interrupts>Interrupts</a></li><li><a href=#the-machine-trap-vector-base-address-register--mtvec>The Machine trap vector base-address register (<code>mtvec</code>)</a></li><li><a href=#privilege-modes>Privilege modes</a><ul><li><a href=#provides-protection-between-different-components-of-the-software-stack>Provides protection between different components of the software stack</a></li><li><a href=#any-attempts-to-perform-an-operation-not-allowed-by-the-current-mode-will-cause-an-exception-to-be-raised>Any attempts to perform an operation not allowed by the current mode will cause an exception to be raised</a></li><li><a href=#these-exceptions-will-normally-cause-traps-into-the-underlying-execution-environment>These exceptions will normally cause traps into the underlying execution environment</a></li><li><a href=#machine-mode>Machine mode</a></li><li><a href=#user-mode-and-supervisor-mode-are-indented-for-conventional-application-and-operating-systems>User mode and supervisor mode are indented for conventional application and operating systems</a></li><li><a href=#exceptions>Exceptions</a></li><li><a href=#supervisor-mode>Supervisor mode</a></li><li><a href=#steps-to-reproduce-the-behavior>*<strong>*Steps to reproduce the behavior**</strong></a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1><a href=/notes/riscv/>RISCV</a></h1><h5>May 31, 2020</h5><p><h3 id=backlinks>Backlinks
<a class=anchor href=#backlinks>#</a></h3><ul><li><a href=/notes/riscv/>RISCV</a></li></ul><dl><dt>tags</dt><dd><a href=/notes/computer-science/>Computer Science</a> <a href=/notes/operating-systems/>Operating Systems</a> <a href=/notes/computer-architecture/>Computer Architecture</a></dd></dl>Understanding<h2 id=understanding-riscv--2020-05-31-15-37-29z-riscv-dot-md--stack-pointer><a href=/notes/riscv/>RISCV</a> stack pointer
<a class=anchor href=#understanding-riscv--2020-05-31-15-37-29z-riscv-dot-md--stack-pointer>#</a></h2><h3 id=l06-riscv-functions--6up--dot-pdf><a href=https://dynalist.io/u/5cYI9hHNgUYs0U47UXe0RZ6U>L06 RISCV Functions(6up).pdf</a>
<a class=anchor href=#l06-riscv-functions--6up--dot-pdf>#</a></h3><h2 id=exceptions>Exceptions
<a class=anchor href=#exceptions>#</a></h2><p>Exception are unusual condition occurring at run time associated with an
instruction in the current RISCV thread. Exceptions may be converted to traps,
but that all depends on the execution environment.</p><h2 id=traps>Traps
<a class=anchor href=#traps>#</a></h2><p>Trap refers to the synchronous transfer control to a trap handler caused by an
exceptional condition occurring within a RISC thread. Trap handlers normally
execute in a more privilege environment.</p><h2 id=interrupts>Interrupts
<a class=anchor href=#interrupts>#</a></h2><p>Interrupt refers to an external event that occurs asynchronously to the current
RISCV thread. When an interrupt occurs, some instruction gets selected to
receive an interrupt exception and subsequently experiences a trap.</p><h2 id=the-machine-trap-vector-base-address-register--mtvec>The Machine trap vector base-address register (<code>mtvec</code>)
<a class=anchor href=#the-machine-trap-vector-base-address-register--mtvec>#</a></h2><p>When something happens in RISCV, the CPU calls the function stored in <code>mtvec</code>.
<code>mtvec</code> is a XLEN (32-64bit wide) read/write register that holds a <strong>trap vector
configuration</strong> which consists of the base address (the function address) and the
vector mode.</p><p>RISCV requires <code>mtvec</code> to be always implemented, but can contain a hardwired to
a read-only value. The base field must always be aligned on a 4-byte boundary
however, mode settings may impose additional base field alignment constraints.</p><p>We can visualize this as an array for XLEN bits:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>/* xlen is 32-bits ie. (int32_t) or 64-bits ie. (int64_t) */</span>
xlen mtvec[xlen];
xlen base <span style=color:#f92672>=</span> mtvec[xlen<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>];
xlen mode <span style=color:#f92672>=</span> mtvec[<span style=color:#ae81ff>2</span>];
</code></pre></div><p>If mode gets set to <code>DIRECT MODE</code>, it means all traps will go to the exact same
function, if <code>VECTOR mode</code> is set, all synchronous exceptions into machine mode
cause the <code>PC</code> to be set to the address of the base field, whereas interrupts
will set <code>PC</code> to <code>base + 4 * cause</code>. For example Table <a href=#table--tbl:exception-codes>1</a> has
machine-mode timer interrupt code <code>7</code> causes the PC to be set to BASE + 0x1c
(BASE + 4 * 7).</p><p><a id=table--tbl:exception-codes></a></p><table><thead><tr><th>Interrupt<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></th><th>Exception code</th><th>Reason</th></tr></thead><tbody><tr><td>1</td><td>0</td><td>User software interrupt</td></tr><tr><td>1</td><td>1</td><td>Supervisor software interrupt</td></tr><tr><td>1</td><td>2</td><td><em>Reserved</em></td></tr><tr><td>1</td><td>3</td><td>Machine software interrupt</td></tr><tr><td>1</td><td>4</td><td>User timer interrupt</td></tr><tr><td>1</td><td>5</td><td>Supervisor timer interrupt</td></tr><tr><td>1</td><td>6</td><td><em>Reserved</em></td></tr><tr><td>1</td><td>7</td><td>Machine timer interrupt</td></tr><tr><td>1</td><td>8</td><td>User external interrupt</td></tr><tr><td>1</td><td>9</td><td>Supervisor external interrupt</td></tr><tr><td>1</td><td>10</td><td><em>Reserved</em></td></tr><tr><td>1</td><td>11</td><td>Machine external interrupt</td></tr><tr><td>1</td><td>>= 12</td><td><em>Reserved</em></td></tr><tr><td>0</td><td>0</td><td>Instruction address misaligned</td></tr><tr><td>0</td><td>1</td><td>Instruction access fault</td></tr><tr><td>0</td><td>2</td><td>Illegal instruction</td></tr><tr><td>0</td><td>3</td><td>Breakpoint</td></tr><tr><td>0</td><td>4</td><td>Load address misaligned</td></tr><tr><td>0</td><td>5</td><td>Load access fault</td></tr><tr><td>0</td><td>6</td><td>Store/AMO address misaligned</td></tr><tr><td>0</td><td>7</td><td>Store/AMO access fault</td></tr><tr><td>0</td><td>8</td><td>Environment call from U-mode</td></tr><tr><td>0</td><td>9</td><td>Environment call from S-mode</td></tr><tr><td>0</td><td>10</td><td><em>Reserved</em></td></tr><tr><td>0</td><td>11</td><td>Environment call from M-mode</td></tr><tr><td>0</td><td>12</td><td>Instruction page fault</td></tr><tr><td>0</td><td>13</td><td>Load page fault</td></tr><tr><td>0</td><td>14</td><td><em>Reserved</em></td></tr><tr><td>0</td><td>15</td><td>Store/AMO page fault</td></tr><tr><td>0</td><td>>= 16</td><td><em>Reserved</em></td></tr></tbody></table><h2 id=privilege-modes>Privilege modes
<a class=anchor href=#privilege-modes>#</a></h2><table><thead><tr><th>Level</th><th>Encoding</th><th>Name</th><th>Abbreviation</th></tr></thead><tbody><tr><td>0</td><td>00</td><td>User/Application</td><td>U</td></tr><tr><td>1</td><td>01</td><td>Supervisor</td><td>S</td></tr><tr><td>2</td><td>10</td><td>Reserved</td><td></td></tr><tr><td>3</td><td>11</td><td>Machine</td><td>M</td></tr></tbody></table><h3 id=provides-protection-between-different-components-of-the-software-stack>Provides protection between different components of the software stack
<a class=anchor href=#provides-protection-between-different-components-of-the-software-stack>#</a></h3><h3 id=any-attempts-to-perform-an-operation-not-allowed-by-the-current-mode-will-cause-an-exception-to-be-raised>Any attempts to perform an operation not allowed by the current mode will cause an exception to be raised
<a class=anchor href=#any-attempts-to-perform-an-operation-not-allowed-by-the-current-mode-will-cause-an-exception-to-be-raised>#</a></h3><h3 id=these-exceptions-will-normally-cause-traps-into-the-underlying-execution-environment>These exceptions will normally cause traps into the underlying execution environment
<a class=anchor href=#these-exceptions-will-normally-cause-traps-into-the-underlying-execution-environment>#</a></h3><h3 id=machine-mode>Machine mode
<a class=anchor href=#machine-mode>#</a></h3><h4 id=highest-privilege>Highest privilege
<a class=anchor href=#highest-privilege>#</a></h4><h4 id=mandatory-privilege-level-for-risc-v-hardware-platform>*<strong>*Mandatory**</strong> privilege level for RISC-V hardware platform
<a class=anchor href=#mandatory-privilege-level-for-risc-v-hardware-platform>#</a></h4><h4 id=trusted-code-environment>Trusted code environment
<a class=anchor href=#trusted-code-environment>#</a></h4><h4 id=low-level-access-to-the-machine-implementation>Low level access to the machine implementation
<a class=anchor href=#low-level-access-to-the-machine-implementation>#</a></h4><h4 id=manage-secure-execution-environments>Manage secure execution environments
<a class=anchor href=#manage-secure-execution-environments>#</a></h4><h3 id=user-mode-and-supervisor-mode-are-indented-for-conventional-application-and-operating-systems>User mode and supervisor mode are indented for conventional application and operating systems
<a class=anchor href=#user-mode-and-supervisor-mode-are-indented-for-conventional-application-and-operating-systems>#</a></h3><table><thead><tr><th>Number of levels</th><th>Supported modes</th><th>Indented Usage</th></tr></thead><tbody><tr><td>1</td><td>M</td><td>Simple embedded systems</td></tr><tr><td>2</td><td>M, U</td><td>Secure embedded systems</td></tr><tr><td>3</td><td>M, S U</td><td>Unix-like operating systems</td></tr></tbody></table><h3 id=exceptions>Exceptions
<a class=anchor href=#exceptions>#</a></h3><h4 id=any-attempts-to-access-non-existent-csr-read-or-write-a-read-only-register-raises-an-illegal-instruction>Any attempts to access non-existent CSR, read or write a read-only register raises an *<strong>*illegal instruction**</strong>
<a class=anchor href=#any-attempts-to-access-non-existent-csr-read-or-write-a-read-only-register-raises-an-illegal-instruction>#</a></h4><h4 id=a-read-write-register-might-also-contain-bits-that-are-read-only-in-which-writes-to-read-only-bits-are-ignored>A read/write register might also contain bits that are read-only, in which writes to read-only bits *<strong>*are ignored**</strong>
<a class=anchor href=#a-read-write-register-might-also-contain-bits-that-are-read-only-in-which-writes-to-read-only-bits-are-ignored>#</a></h4><h3 id=supervisor-mode>Supervisor mode
<a class=anchor href=#supervisor-mode>#</a></h3><p><a href=http://www-inst.eecs.berkeley.edu/~cs152/sp12/handouts/riscv-supervisor.pdf>http://www-inst.eecs.berkeley.edu/~cs152/sp12/handouts/riscv-supervisor.pdf</a></p><h3 id=steps-to-reproduce-the-behavior>*<strong>*Steps to reproduce the behavior**</strong>
<a class=anchor href=#steps-to-reproduce-the-behavior>#</a></h3><h4 id=switch-to-machine-mode--if-not-already-by-default>Switch to machine mode (if not already by default)
<a class=anchor href=#switch-to-machine-mode--if-not-already-by-default>#</a></h4><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>0 for asynchronous and 1 for synchronous <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/benmezger/blog/commit/10b8fc16eb56583348adde417f253c9cd2039bc7 title="Last modified by Ben Mezger | June 6, 2020" target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 6, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/benmezger/blog/edit/master/content/notes/2020-05-31--15-37-29Z--riscv.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"benmezger"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#backlinks>Backlinks</a></li></ul></li><li><a href=#understanding-riscv--2020-05-31-15-37-29z-riscv-dot-md--stack-pointer>Understanding <a href=HAHAHUGOSHORTCODE-s4-HBHB>RISCV</a> stack pointer</a><ul><li><a href=#l06-riscv-functions--6up--dot-pdf><a href=https://dynalist.io/u/5cYI9hHNgUYs0U47UXe0RZ6U>L06 RISCV Functions(6up).pdf</a></a></li></ul></li><li><a href=#exceptions>Exceptions</a></li><li><a href=#traps>Traps</a></li><li><a href=#interrupts>Interrupts</a></li><li><a href=#the-machine-trap-vector-base-address-register--mtvec>The Machine trap vector base-address register (<code>mtvec</code>)</a></li><li><a href=#privilege-modes>Privilege modes</a><ul><li><a href=#provides-protection-between-different-components-of-the-software-stack>Provides protection between different components of the software stack</a></li><li><a href=#any-attempts-to-perform-an-operation-not-allowed-by-the-current-mode-will-cause-an-exception-to-be-raised>Any attempts to perform an operation not allowed by the current mode will cause an exception to be raised</a></li><li><a href=#these-exceptions-will-normally-cause-traps-into-the-underlying-execution-environment>These exceptions will normally cause traps into the underlying execution environment</a></li><li><a href=#machine-mode>Machine mode</a></li><li><a href=#user-mode-and-supervisor-mode-are-indented-for-conventional-application-and-operating-systems>User mode and supervisor mode are indented for conventional application and operating systems</a></li><li><a href=#exceptions>Exceptions</a></li><li><a href=#supervisor-mode>Supervisor mode</a></li><li><a href=#steps-to-reproduce-the-behavior>*<strong>*Steps to reproduce the behavior**</strong></a></li></ul></li></ul></li></ul></nav></aside></main></body></html>